# Verilator Register Instrumentation

This repository provides a script to instrument C++ source code generated by
Verilator with coverage information and an estimate of the number of register
bitflips in the design.

## Usage

Requirements:

* Linux. Tested on Ubuntu and ArchLinux
* Make.
* Python. Tested using Python 3.11.2
  * `pycparser`. Install using `pip install pycparser`
* Verilator. Tested using Verilator 5.018

Take your design and Verilator testbench. Run the command to generate the
Verilator C++ source code. Replace the top module, file list and testbench with
the appropriate files.

```bash
# If you have ran this command before, first run `rm -rf obj_dir` to remove the
# existing `obj_dir` directory.
verilator -O3 -cc [TOP MODULE .v / .sv] -f [FILE LIST .txt] --exe [TESTBENCH .cpp]
```

This should have generated a `obj_dir` folder with all the C++ files.

Then, move your working directory (with `cd path/to/this/cloned/repository`) to
the cloned contents of this repository. Run the following command.

```bash
./instrument.py [PATH/TO/OBJ_DIR] [NAME OF TOP MODULE]
```

This will add the instrumentation to the C++ source files.

Now run the following command to build your design.

```bash
make -C obj_dir -f [NAME OF TOP MODULE].mk [NAME OF TOP MODULE]
```

When you now run, the following command your simulation will run.

```bash
./obj_dir/[NAME OF TOP MODULE]
```

This will produce two files:

* `vri-bitflips` which contains a 8 bytes which represent big-endian
estimate of the amount the bitflips during the simulation. The name of this
file can be changed by setting `VRI_BITFLIP_FILENAME` during simulation.
* `vri-covmap` contains `pow(2, 16)` bytes which represents the
coverage-map during the execution of the simulation. The name of this file can
be changed by setting `VRI_COVMAP_FILENAME` during simulation.

## License

Licensed under a MIT license.